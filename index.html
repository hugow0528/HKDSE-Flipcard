<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wabi-Sabi Flashcards | HKDSE Study Tool</title>
  <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^0.12.0"
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --surface-color: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --accent-color: #4a6a8a;
      --accent-hover: #3a556d;
      --border-color: #dee2e6;
      --error-color: #dc3545;
      --correct-color: #198754;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --font-family-en: 'Inter', sans-serif;
      --font-family-zh: 'Noto Sans TC', sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-family-en), var(--font-family-zh);
      background-color: var(--bg-color);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem 1rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      background-color: var(--surface-color);
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px var(--shadow-light);
      width: 100%;
      max-width: 900px;
      text-align: center;
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    
    .container.hidden {
        opacity: 0;
        transform: scale(0.98);
        pointer-events: none;
    }

    .app-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .language-switcher {
        display: flex;
        gap: 0.5rem;
    }
    
    .lang-button {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
    }
    
    .lang-button.active {
        background-color: var(--accent-color);
        color: white;
    }
    
    .lang-button:not(.active):hover {
        background-color: #e9ecef;
        color: var(--text-primary);
    }

    h1 {
      color: var(--text-primary);
      margin: 0;
      font-weight: 700;
      font-size: 2rem;
      text-align: left;
    }
    
    .app-header p {
      text-align: left;
      margin: 0.5rem 0 1.5rem 0;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    #apiKeyInput, textarea {
      width: 100%;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--bg-color);
      color: var(--text-primary);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: inherit;
    }
    
    #apiKeyInput:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(74, 106, 138, 0.2);
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
      margin-bottom: 1rem;
    }

    .main-controls, .dictation-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    button, .button {
      background-color: var(--accent-color);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
    }
    
    .button.secondary { background-color: #6c757d; }
    .button.secondary:hover { background-color: #5a6268; }

    button:hover:not(:disabled), .button:hover:not(:disabled) {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    button:disabled {
      background-color: #adb5bd;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .status-message {
      margin-top: 1.5rem;
      font-weight: 500;
      min-height: 1.5em;
      transition: color 0.3s ease;
    }

    .status-message.error { color: var(--error-color); }

    /* View Transitions */
    .view {
      transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    }
    .view.hidden {
      opacity: 0;
      transform: scale(0.98);
      pointer-events: none;
      position: absolute;
      width: calc(100% - 5rem); /* Match container padding */
    }

    .mode-selection-container {
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }
    
    .mode-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 2rem;
      width: 100%;
      max-width: 320px;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      text-align: left;
    }
    
    .mode-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px var(--shadow-light);
      border-color: var(--accent-color);
    }
    
    .mode-card h2 { margin-top: 0; color: var(--accent-color); }
    .mode-card p { color: var(--text-secondary); margin-bottom: 0; font-size: 0.95rem; }
    
    .back-button {
      background: #e9ecef;
      border: none;
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .back-button:hover { background-color: #dee2e6; color: var(--text-primary); }

    .mode-container-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .mode-container-header h2 {
      font-size: 1.5rem;
    }

    .flashcards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }

    .flashcard {
      background-color: transparent;
      width: 250px;
      height: 180px;
      cursor: pointer;
      perspective: 1000px;
    }

    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.7s;
      transform-style: preserve-3d;
      box-shadow: 0 4px 15px var(--shadow-light);
      border-radius: 10px;
    }

    .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }

    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background-color: var(--surface-color);
    }
    
    .flashcard.flipped .flashcard-back { border-color: var(--accent-color); }
    .flashcard-back { transform: rotateY(180deg); }
    .term { font-size: 1.25em; font-weight: 500; }
    .definition { font-size: 1em; color: var(--text-secondary); line-height: 1.4; }
    
    .quiz-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .quiz-card {
      width: 100%;
      min-height: 160px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background-color: var(--surface-color);
      box-shadow: 0 4px 15px var(--shadow-light);
    }
    
    .quiz-answer-input, .dictation-answer-input {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    
    .quiz-feedback { width: 100%; padding: 1rem; border-radius: 8px; text-align: left; line-height: 1.5; }
    .quiz-feedback.correct { background-color: #e8f5e9; border: 1px solid var(--correct-color); }
    .quiz-feedback.partial { background-color: #fff8e1; border: 1px solid #d1a55d; }
    .quiz-feedback.incorrect { background-color: #fce4e4; border: 1px solid var(--error-color); }
    .quiz-feedback strong { display: block; margin-bottom: 0.5rem; font-size: 1.1rem; }
    .quiz-feedback strong.correct { color: var(--correct-color); }
    .quiz-feedback strong.partial { color: #d1a55d; }
    .quiz-feedback strong.incorrect { color: var(--error-color); }

    .progress-text { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; }
    
    .dictation-listen-button { font-size: 2.5rem; padding: 1.5rem; border-radius: 50%; width: 80px; height: 80px; }

    .dictation-results-table {
      width: 100%; margin-top: 1.5rem; border-collapse: collapse; text-align: left;
    }
    .dictation-results-table th, .dictation-results-table td {
      padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color);
    }
    .dictation-results-table th { font-weight: 700; background-color: var(--bg-color); }
    .dictation-results-table tr:last-child td { border-bottom: none; }
    .dictation-results-table .status-correct { color: var(--correct-color); }
    .dictation-results-table .status-incorrect { color: var(--error-color); }
    .dictation-results-table .correct-answer-feedback { font-size: 0.85em; color: var(--text-secondary); margin-top: 0.25rem; }

    .hidden { display: none; }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      width: 20px;
      height: 20px;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    button .button-text.hidden { display: none; }
    
    .study-options-container {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      background-color: var(--bg-color);
      padding: 0.5rem;
      border-radius: 8px;
      margin: 1rem auto 0;
    }

    .study-option-btn {
      background: none;
      border: 1px solid transparent;
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .study-option-btn.active {
      background-color: var(--surface-color);
      color: var(--accent-color);
      box-shadow: 0 2px 5px var(--shadow-light);
      border-color: var(--border-color);
    }
    
    /* DICTATION PAGE STYLES */
    .dictation-page-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-color);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 1rem;
        z-index: 100;
        opacity: 0;
        transform: scale(1.02);
        pointer-events: none;
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .dictation-page-container.visible {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
    }
    .dictation-page-content {
        position: relative;
        background-color: var(--surface-color);
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 8px 32px var(--shadow-light);
        width: 100%;
        max-width: 600px;
        text-align: center;
    }
    .dictation-page-back-button {
        position: absolute;
        top: 1.25rem;
        left: 1.25rem;
    }
    .dictation-translation {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        font-family: var(--font-family-zh);
    }
    .dictation-feedback {
        margin-top: 1rem;
        font-weight: 500;
        min-height: 1.5em;
    }

    /* MATCH GAME STYLES */
    .match-game-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        max-width: 700px;
        margin: 1rem auto 0;
        perspective: 1000px;
    }
    .match-card {
        background-color: var(--surface-color);
        border-radius: 8px;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 0.5rem;
        cursor: pointer;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s, box-shadow 0.3s;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px var(--shadow-light);
    }
    .match-card-content {
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        transform: rotateY(180deg);
        font-size: 0.9rem;
    }
    .match-card::before { /* Card back */
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: var(--accent-color);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 8px;
        transition: background-color 0.2s;
    }
     .match-card:hover::before {
        background-color: var(--accent-hover);
    }
    .match-card.flipped {
        transform: rotateY(180deg);
    }
    .match-card.matched {
        cursor: default;
        border-color: var(--correct-color);
        box-shadow: 0 0 10px rgba(25, 135, 84, 0.3);
        transform: rotateY(180deg);
    }
    .match-card.mismatched {
      border-color: var(--error-color);
    }
    .match-card.flipped.matched::before {
        background-color: #e8f5e9;
    }
    .match-completion-message {
        margin-top: 2rem;
    }

    @media (max-width: 768px) {
      body { padding: 1rem 0.5rem; }
      .container { padding: 1.5rem; }
      .header-top { flex-direction: column; align-items: flex-start; gap: 1rem; }
      h1 { font-size: 1.8rem; }
      .language-switcher { align-self: flex-start; }
      .main-controls, .dictation-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
      .flashcard { width: 100%; max-width: 300px; }
      .mode-selection-container { flex-direction: column; align-items: center; }
      .dictation-page-content { padding: 1.5rem; }
      .view.hidden { width: calc(100% - 3rem); }

      /* Responsive Dictation Table */
      .dictation-results-table thead {
        display: none;
      }
      .dictation-results-table, .dictation-results-table tbody, .dictation-results-table tr, .dictation-results-table td {
        display: block;
        width: 100%;
      }
      .dictation-results-table tr {
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
      }
      .dictation-results-table td {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        border: none;
        text-align: right;
        align-items: center;
      }
      .dictation-results-table td::before {
        content: attr(data-label);
        font-weight: 500;
        text-align: left;
        margin-right: 1rem;
        color: var(--text-primary);
      }
      .dictation-results-table td:last-child {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <header class="app-header">
      <div class="header-top">
        <h1 data-translate-key="appTitle">Flipcard Study</h1>
        <div class="language-switcher">
          <button class="lang-button" data-lang="en">English</button>
          <button class="lang-button" data-lang="zh-HK">ÁπÅÈ´î‰∏≠Êñá</button>
        </div>
      </div>
      <p data-translate-key="appDescription">Generate study cards for your HKDSE prep or run vocabulary dictation drills. Pick a mode to get started!</p>
      <input type="password" id="apiKeyInput" data-translate-key="apiKeyPlaceholder" placeholder="Enter your Google AI API Key here">
    </header>

    <main id="mainContent">
      <!-- MODE SELECTION -->
      <div id="modeSelectionContainer" class="view mode-selection-container">
          <div class="mode-card" id="selectStudyMode">
              <h2 data-translate-key="studyModeTitle">üìö Study Mode</h2>
              <p data-translate-key="studyModeDescription">Enter a topic and AI will generate flashcards and a quiz for you.</p>
          </div>
          <div class="mode-card" id="selectDictationMode">
              <h2 data-translate-key="dictationModeTitle">üéß Dictation Mode</h2>
              <p data-translate-key="dictationModeDescription">Input your vocabulary list and test yourself with audio dictation.</p>
          </div>
      </div>

      <!-- STUDY MODE -->
      <div id="studyModeContainer" class="view hidden">
        <div class="mode-container-header">
          <button class="back-button" aria-label="Back to mode selection">‚Üê</button>
          <h2 data-translate-key="studyModeTitle">Study Mode</h2>
        </div>
        <textarea id="topicInput" data-translate-key="studyTopicPlaceholder" placeholder="Enter a topic, e.g., 'Photosynthesis' or 'Medieval Europe'"></textarea>
        <div class="main-controls">
          <button id="generateButton">
            <span class="button-text" data-translate-key="generateButton">Generate Flashcards</span>
            <span class="spinner hidden"></span>
          </button>
          <button id="importButton" data-translate-key="importButton">Import Cards</button>
          <button id="exportButton" class="hidden" data-translate-key="exportButton">Export Cards</button>
        </div>
         <div class="study-options-container hidden" id="studyOptionsContainer">
           <button class="study-option-btn active" data-mode="study" data-translate-key="studyModeLabel">Study</button>
           <button class="study-option-btn" data-mode="quiz" data-translate-key="quizModeLabel">Quiz</button>
           <button class="study-option-btn" data-mode="match" data-translate-key="matchModeLabel">Match</button>
         </div>
      </div>
      
      <!-- DICTATION MODE -->
      <div id="dictationModeContainer" class="view hidden">
        <div class="mode-container-header">
            <button class="back-button" aria-label="Back to mode selection">‚Üê</button>
            <h2 data-translate-key="dictationModeTitle">Dictation Mode</h2>
        </div>
        <textarea id="dictationListInput" data-translate-key="dictationListPlaceholder" placeholder="Enter your vocabulary list here. Any format is okay - AI will clean it up for you."></textarea>
        <div class="dictation-controls">
            <button id="translateButton">
                <span class="button-text" data-translate-key="translateButton">Translate to Chinese</span>
                <span class="spinner hidden"></span>
            </button>
            <button id="startDictationButton">
                <span class="button-text" data-translate-key="startDictationButton">Start Dictation</span>
                <span class="spinner hidden"></span>
            </button>
        </div>
      </div>
    </main>
    
    <div id="statusMessage" class="status-message"></div>
    <div id="content-area">
      <!-- Dynamic content (flashcards or quiz) will be injected here -->
    </div>
  </div>

  <!-- DICTATION PAGE -->
  <div id="dictationPage" class="dictation-page-container">
    <!-- Dictation practice/results will be injected here -->
  </div>

  <input type="file" id="importInput" class="hidden" accept=".json">

  <script type="module">
    import { GoogleGenAI, Type } from "@google/genai";

    // --- I18n Translations ---
    const translations = {
        en: {
            appTitle: "Flipcard Study",
            appDescription: "Generate study cards for your HKDSE prep or run vocabulary dictation drills. Pick a mode to get started!",
            apiKeyPlaceholder: "Enter your Google AI API Key here",
            studyModeTitle: "üìö Study Mode",
            studyModeDescription: "Enter a topic and AI will generate flashcards and a quiz for you.",
            dictationModeTitle: "üéß Dictation Mode",
            dictationModeDescription: "Input your vocabulary list and test yourself with audio dictation.",
            studyTopicPlaceholder: "Enter a topic, e.g., 'Photosynthesis' or 'Medieval Europe'",
            generateButton: "Generate Flashcards",
            importButton: "Import Cards",
            exportButton: "Export Cards",
            studyModeLabel: "Study",
            quizModeLabel: "Quiz",
            matchModeLabel: "Match",
            dictationListPlaceholder: "Enter your vocabulary list here. Any format is okay - AI will clean it up for you.",
            translateButton: "Translate to Chinese",
            startDictationButton: "Start Dictation",
            statusGenerating: "Generating flashcards for you...",
            statusTranslating: "Translating your list...",
            statusParsing: "Cleaning up your list...",
            errorApiKey: "Please enter your Google AI API Key.",
            errorTopic: "Please enter a topic.",
            errorNoCards: "Could not generate flashcards. Please try a different topic.",
            errorGeneral: "An error occurred: ",
            errorUnknown: "Unknown error",
            errorImport: "Import failed: ",
            errorNoExport: "No cards to export.",
            errorImportInvalidJSON: "Import failed: The file is not a valid JSON.",
            errorImportInvalidStructure: "Import failed: Each flashcard must have a 'term' and a 'definition'.",
            errorSpeechSynthesis: "Your browser does not support speech synthesis.",
            errorDictationList: "Please enter a vocabulary list.",
            errorNoValidWords: "No valid words found in your list.",
            quizQuestion: "Question",
            quizScore: "Score",
            quizAnswerPlaceholder: "Type your answer here...",
            submitAnswerButton: "Submit Answer",
            evaluatingAnswer: "Evaluating...",
            nextQuestionButton: "Next Question",
            quizCompleteTitle: "Quiz Complete!",
            finalScore: "Your final score",
            restartQuizButton: "Restart Quiz",
            dictationWord: "Word",
            checkButton: "Check",
            nextWordButton: "Next ‚Üí",
            dictationCompleteTitle: "Dictation Complete!",
            correctWord: "Correct Word",
            yourAnswer: "Your Answer",
            status: "Status",
            practiceAgainButton: "Practice Again",
            backToMenuButton: "Back to Main Menu",
            backButtonLabel: "Back",
            feedbackCorrectAnswerIs: "The correct answer is:",
            matchGameComplete: "Well done!",
            playAgainButton: "Play Again",
            returnToStudyButton: "Return to Study",
        },
        'zh-HK': {
            appTitle: "Ê∫´ÁøíÂç°Â≠∏Áøí",
            appDescription: "ÁÇ∫ÊÇ®ÁöÑÈ¶ôÊ∏Ø‰∏≠Â≠∏ÊñáÊÜëËÄÉË©¶ (HKDSE) ÁîüÊàêÂ≠∏ÁøíÂç°ÊàñÈÄ≤Ë°åË©ûÂΩôËÅΩÂØ´Á∑¥Áøí„ÄÇÈÅ∏Êìá‰∏ÄÁ®ÆÊ®°ÂºèÂç≥ÂèØÈñãÂßãÔºÅ",
            apiKeyPlaceholder: "Âú®Ê≠§ËôïËº∏ÂÖ•ÊÇ®ÁöÑ Google AI API Key",
            studyModeTitle: "üìö Â≠∏ÁøíÊ®°Âºè",
            studyModeDescription: "Ëº∏ÂÖ•‰∏ÄÂÄã‰∏ªÈ°åÔºåAIÊúÉÁÇ∫ÊÇ®ÁîüÊàêÂ≠∏ÁøíÂç°ÂíåÊ∏¨È©ó„ÄÇ",
            dictationModeTitle: "üéß ËÅΩÂØ´Ê®°Âºè",
            dictationModeDescription: "Ëº∏ÂÖ•ÊÇ®ÁöÑË©ûÂΩôÂàóË°®Ôºå‰∏¶ÈÄöÈÅéËÅΩÂØ´Á∑¥Áøí‰æÜÊ∏¨Ë©¶Ëá™Â∑±„ÄÇ",
            studyTopicPlaceholder: "Ëº∏ÂÖ•‰∏ªÈ°åÔºå‰æãÂ¶ÇÔºö‚ÄúÂÖâÂêà‰ΩúÁî®‚ÄùÊàñ‚Äú‰∏≠‰∏ñÁ¥ÄÊ≠êÊ¥≤‚Äù",
            generateButton: "ÁîüÊàêÂ≠∏ÁøíÂç°",
            importButton: "Â∞éÂÖ•Â≠∏ÁøíÂç°",
            exportButton: "Â∞éÂá∫Â≠∏ÁøíÂç°",
            studyModeLabel: "Â≠∏Áøí",
            quizModeLabel: "Ê∏¨È©ó",
            matchModeLabel: "ÈÖçÂ∞ç",
            dictationListPlaceholder: "Âú®Ê≠§ËôïËº∏ÂÖ•ÊÇ®ÁöÑË©ûÂΩôÂàóË°®„ÄÇ‰ªª‰ΩïÊ†ºÂºèÈÉΩÂèØ‰ª• - AIÊúÉÁÇ∫ÊÇ®Êï¥ÁêÜ„ÄÇ",
            translateButton: "ÁøªË≠ØÁÇ∫‰∏≠Êñá",
            startDictationButton: "ÈñãÂßãËÅΩÂØ´",
            statusGenerating: "Ê≠£Âú®ÁÇ∫ÊÇ®ÁîüÊàêÂ≠∏ÁøíÂç°...",
            statusTranslating: "Ê≠£Âú®ÁøªË≠ØÊÇ®ÁöÑÂàóË°®...",
            statusParsing: "Ê≠£Âú®Êï¥ÁêÜÊÇ®ÁöÑÂàóË°®...",
            errorApiKey: "Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ Google AI API Key„ÄÇ",
            errorTopic: "Ë´ãËº∏ÂÖ•‰∏ÄÂÄã‰∏ªÈ°å„ÄÇ",
            errorNoCards: "ÁÑ°Ê≥ïÁîüÊàêÂ≠∏ÁøíÂç°„ÄÇË´ãÂòóË©¶‰∏çÂêåÁöÑ‰∏ªÈ°åÊàñÈáçÊñ∞Êé™Ëæ≠„ÄÇ",
            errorGeneral: "ÁîüÊàêÊôÇÁôºÁîüÈåØË™§: ",
            errorUnknown: "Êú™Áü•ÈåØË™§",
            errorImport: "Â∞éÂÖ•Â§±Êïó: ",
            errorNoExport: "Ê≤íÊúâÂèØÂ∞éÂá∫ÁöÑÂ≠∏ÁøíÂç°„ÄÇ",
            errorImportInvalidJSON: "Â∞éÂÖ•Â§±ÊïóÔºöÊñá‰ª∂‰∏çÊòØÊúâÊïàÁöÑJSONÊ†ºÂºè„ÄÇ",
            errorImportInvalidStructure: "Â∞éÂÖ•Â§±ÊïóÔºöÊØèÂºµÂ≠∏ÁøíÂç°ÈÉΩÂøÖÈ†àÂåÖÂê´'term'Âíå'definition'„ÄÇ",
            errorSpeechSynthesis: "ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊåÅË™ûÈü≥ÂêàÊàê„ÄÇ",
            errorDictationList: "Ë´ãËº∏ÂÖ•Ë©ûÂΩôÂàóË°®„ÄÇ",
            errorNoValidWords: "ÊÇ®ÁöÑÂàóË°®‰∏≠Êú™ÊâæÂà∞ÊúâÊïàË©ûÂΩô„ÄÇ",
            quizQuestion: "ÂïèÈ°å",
            quizScore: "ÂàÜÊï∏",
            quizAnswerPlaceholder: "Âú®ÈÄôË£°Ëº∏ÂÖ•ÊÇ®ÁöÑÁ≠îÊ°à...",
            submitAnswerButton: "Êèê‰∫§Á≠îÊ°à",
            evaluatingAnswer: "Ë©ï‰º∞‰∏≠...",
            nextQuestionButton: "‰∏ã‰∏ÄÂÄãÂïèÈ°å",
            quizCompleteTitle: "Ê∏¨È©óÂÆåÊàêÔºÅ",
            finalScore: "ÊÇ®ÁöÑÊúÄÁµÇÂàÜÊï∏",
            restartQuizButton: "ÈáçÊñ∞ÈñãÂßãÊ∏¨È©ó",
            dictationWord: "Ë©ûË™û",
            checkButton: "Ê™¢Êü•",
            nextWordButton: "‰∏ã‰∏ÄÂÄã ‚Üí",
            dictationCompleteTitle: "ËÅΩÂØ´ÂÆåÊàêÔºÅ",
            correctWord: "Ê≠£Á¢∫Ë©ûË™û",
            yourAnswer: "ÊÇ®ÁöÑÁ≠îÊ°à",
            status: "ÁãÄÊÖã",
            practiceAgainButton: "ÂÜçÊ¨°Á∑¥Áøí",
            backToMenuButton: "ËøîÂõû‰∏ªËèúÂñÆ",
            backButtonLabel: "ËøîÂõû",
            feedbackCorrectAnswerIs: "Ê≠£Á¢∫Á≠îÊ°àÊòØÔºö",
            matchGameComplete: "ÂÆåÊàêÔºÅ",
            playAgainButton: "ÂÜçÁé©‰∏ÄÊ¨°",
            returnToStudyButton: "ËøîÂõûÂ≠∏Áøí",
        }
    };
    let currentLanguage = 'en';

    // --- DOM Elements ---
    const appContainer = document.getElementById('appContainer');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const statusMessage = document.getElementById('statusMessage');
    const contentArea = document.getElementById('content-area');

    // View Containers
    const modeSelectionContainer = document.getElementById('modeSelectionContainer');
    const studyModeContainer = document.getElementById('studyModeContainer');
    const dictationModeContainer = document.getElementById('dictationModeContainer');
    const dictationPage = document.getElementById('dictationPage');

    // Mode Selection
    const selectStudyMode = document.getElementById('selectStudyMode');
    const selectDictationMode = document.getElementById('selectDictationMode');
    
    // Study Mode Elements
    const topicInput = document.getElementById('topicInput');
    const generateButton = document.getElementById('generateButton');
    const importButton = document.getElementById('importButton');
    const exportButton = document.getElementById('exportButton');
    const importInput = document.getElementById('importInput');
    const studyOptionsContainer = document.getElementById('studyOptionsContainer');
    
    // Dictation Mode Elements
    const dictationListInput = document.getElementById('dictationListInput');
    const startDictationButton = document.getElementById('startDictationButton');
    const translateButton = document.getElementById('translateButton');

    // --- State ---
    let ai = null;
    let flashcards = [];
    let currentStudyMode = 'study';
    let quizIndex = 0;
    let quizScore = 0;
    let maxQuizScore = 0;
    let dictationWords = []; // Will now be an array of objects {english, chinese}
    let userAnswers = [];
    let currentDictationIndex = 0;

    // --- Utility Functions ---
    const getTranslation = (key) => translations[currentLanguage][key] || key;

    function handleError(key, message = '') {
      statusMessage.textContent = getTranslation(key) + message;
      statusMessage.classList.add('error');
    }

    function showStatus(key, isError = false) {
      statusMessage.textContent = key ? getTranslation(key) : '';
      statusMessage.classList.toggle('error', isError);
    }
    
    function toggleLoading(button, isLoading) {
        button.disabled = isLoading;
        const buttonText = button.querySelector('.button-text');
        const spinner = button.querySelector('.spinner');
        if (isLoading) {
            buttonText?.classList.add('hidden');
            spinner?.classList.remove('hidden');
        } else {
            buttonText?.classList.remove('hidden');
            spinner?.classList.add('hidden');
        }
    }

    // --- I18n Functions ---
    function setLanguage(lang) {
        if (!translations[lang]) return;
        currentLanguage = lang;
        localStorage.setItem('userLanguage', lang);

        document.documentElement.lang = lang;
        
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            const translation = getTranslation(key);
            if (el.placeholder) {
                el.placeholder = translation;
            } else {
                el.textContent = translation;
            }
        });
        
        document.querySelectorAll('.lang-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });
    }

    function initializeLanguage() {
        const savedLang = localStorage.getItem('userLanguage');
        const browserLang = navigator.language.startsWith('zh') ? 'zh-HK' : 'en';
        setLanguage(savedLang || browserLang);
    }

    // --- Initialization ---
    function initialize() {
        setupEventListeners();
        updateButtonStates();
        initializeLanguage();
    }
    
    function setupEventListeners() {
        apiKeyInput.addEventListener('input', updateButtonStates);
        
        document.querySelectorAll('.lang-button').forEach(btn => {
            btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
        });
        
        selectStudyMode.addEventListener('click', () => showView('study'));
        selectDictationMode.addEventListener('click', () => showView('dictation'));
        document.querySelectorAll('.back-button').forEach(btn => {
            btn.addEventListener('click', () => {
                showView('selection');
                resetStudyMode();
            });
        });
        
        generateButton.addEventListener('click', generateFlashcards);
        importButton.addEventListener('click', () => importInput.click());
        exportButton.addEventListener('click', exportFlashcards);
        importInput.addEventListener('change', importFlashcards);
        
        studyOptionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('study-option-btn')) {
                handleStudyModeChange(e.target.dataset.mode);
            }
        });
        
        startDictationButton.addEventListener('click', startDictation);
        translateButton.addEventListener('click', translateVocabulary);
    }
    
    function updateButtonStates() {
      const hasApiKey = apiKeyInput.value.trim().length > 0;
      generateButton.disabled = !hasApiKey;
      startDictationButton.disabled = !hasApiKey;
      translateButton.disabled = !hasApiKey;
    }

    // --- View Management ---
    function showView(viewName) {
        [modeSelectionContainer, studyModeContainer, dictationModeContainer].forEach(v => v.classList.add('hidden'));
        contentArea.innerHTML = '';
        showStatus('');

        let viewToShow;
        switch(viewName) {
            case 'study': viewToShow = studyModeContainer; break;
            case 'dictation': viewToShow = dictationModeContainer; break;
            case 'selection':
            default: viewToShow = modeSelectionContainer; break;
        }
        
        setTimeout(() => {
            viewToShow.classList.remove('hidden');
        }, 10);
    }
    
    function showDictationPage(show) {
        if (show) {
            appContainer.classList.add('hidden');
            dictationPage.classList.add('visible');
        } else {
            appContainer.classList.remove('hidden');
            dictationPage.classList.remove('visible');
        }
    }

    // --- AI Initialization ---
    function initializeAi() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            handleError('errorApiKey');
            return false;
        }
        if (!ai || ai.apiKey !== apiKey) {
            try {
                ai = new GoogleGenAI({ apiKey });
            } catch(e) {
                handleError('errorApiKey');
                return false;
            }
        }
        return true;
    }
    
    function resetStudyMode() {
        flashcards = [];
        studyOptionsContainer.classList.add('hidden');
        exportButton.classList.add('hidden');
        currentStudyMode = 'study';
        contentArea.innerHTML = '';
    }

    // --- Study Mode Functions ---
    async function generateFlashcards() {
      if (!initializeAi()) return;
      
      const topic = topicInput.value.trim();
      if (!topic) {
        handleError('errorTopic');
        return;
      }

      showStatus('statusGenerating');
      toggleLoading(generateButton, true);
      resetStudyMode();

      try {
        const prompt = `As an expert tutor for the Hong Kong Diploma of Secondary Education (HKDSE) curriculum, create a set of at least 5 flashcards for the topic "${topic}". The terms and definitions should be clear, concise, and directly relevant to the HKDSE syllabus.`;
        const result = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: { parts: [{ text: prompt }] },
            config: {
                responseMimeType: "application/json",
                responseSchema: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { term: { type: Type.STRING }, definition: { type: Type.STRING } } } }
            }
        });
        const parsedFlashcards = JSON.parse(result.text);

        if (parsedFlashcards && parsedFlashcards.length > 0) {
          flashcards = parsedFlashcards;
          showStatus('');
          studyOptionsContainer.classList.remove('hidden');
          exportButton.classList.remove('hidden');
          updateButtonStates();
          handleStudyModeChange('study');
        } else {
          handleError('errorNoCards');
        }
      } catch (error) {
        console.error('Error generating content:', error);
        handleError('errorGeneral', error.message || getTranslation('errorUnknown'));
      } finally {
        toggleLoading(generateButton, false);
      }
    }

    function exportFlashcards() {
      if (flashcards.length === 0) {
        handleError('errorNoExport');
        return;
      }
      const topic = topicInput.value.trim().replace(/\s+/g, '_') || 'flashcards';
      const fileName = `flashcards-${topic}.json`;
      const dataStr = JSON.stringify(flashcards, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importFlashcards(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          let importedData;
          try {
            importedData = JSON.parse(e.target.result);
          } catch(jsonError) {
             throw new Error(getTranslation('errorImportInvalidJSON'));
          }
          
          if (!Array.isArray(importedData) || importedData.some(item => !item.term || !item.definition)) {
            throw new Error(getTranslation('errorImportInvalidStructure'));
          }
          flashcards = importedData;
          showStatus('');
          studyOptionsContainer.classList.remove('hidden');
          exportButton.classList.remove('hidden');
          updateButtonStates();
          topicInput.value = 'Imported Flashcards';
          handleStudyModeChange('study');
        } catch (error) {
          handleError('errorImport', error.message);
        } finally {
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    function handleStudyModeChange(mode) {
      if (flashcards.length === 0) return;
      currentStudyMode = mode;
      
      document.querySelectorAll('.study-option-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      renderStudyContent();
    }
    
    function renderStudyContent() {
        contentArea.innerHTML = '';
        switch(currentStudyMode) {
            case 'study':
                renderStudyMode();
                break;
            case 'quiz':
                quizIndex = 0;
                quizScore = 0;
                maxQuizScore = flashcards.length * 2;
                renderQuizMode();
                break;
            case 'match':
                renderMatchGame();
                break;
        }
    }

    function renderStudyMode() {
      const container = document.createElement('div');
      container.className = 'flashcards-container';
      flashcards.forEach(cardData => {
        const cardEl = document.createElement('div');
        cardEl.className = 'flashcard';
        cardEl.innerHTML = `<div class="flashcard-inner"><div class="flashcard-front"><div class="term">${cardData.term}</div></div><div class="flashcard-back"><div class="definition">${cardData.definition}</div></div></div>`;
        cardEl.addEventListener('click', () => cardEl.classList.toggle('flipped'));
        container.appendChild(cardEl);
      });
      contentArea.appendChild(container);
    }
    
    function renderQuizMode() {
        if (quizIndex >= flashcards.length) {
            renderQuizEndScreen();
            return;
        }
        const currentCard = flashcards[quizIndex];
        const quizContainer = document.createElement('div');
        quizContainer.className = 'quiz-container';
        quizContainer.innerHTML = `
            <div class="progress-text">${getTranslation('quizQuestion')} ${quizIndex + 1} / ${flashcards.length} | ${getTranslation('quizScore')}: ${quizScore} / ${maxQuizScore}</div>
            <div class="quiz-card"><div class="term">${currentCard.term}</div></div>
            <textarea class="quiz-answer-input" placeholder="${getTranslation('quizAnswerPlaceholder')}"></textarea>
            <button id="submitAnswerBtn">${getTranslation('submitAnswerButton')}</button>
            <div id="quizFeedbackContainer"></div>`;
        contentArea.appendChild(quizContainer);
        quizContainer.querySelector('#submitAnswerBtn').addEventListener('click', () => {
            const answer = quizContainer.querySelector('.quiz-answer-input').value;
            checkQuizAnswer(answer, currentCard);
        });
    }
    
    async function checkQuizAnswer(userAnswer, card) {
        if (!userAnswer.trim() || !initializeAi()) return;
        const submitBtn = document.getElementById('submitAnswerBtn');
        toggleLoading(submitBtn, true);
        submitBtn.innerHTML = `<span class="spinner"></span>`;
        const feedbackContainer = document.getElementById('quizFeedbackContainer');
        feedbackContainer.innerHTML = '';
        
        try {
            const prompt = `You are an HKDSE exam marker. The subject is "${topicInput.value}". The question is: "What is ${card.term}?". The model answer is: "${card.definition}". The student's answer is: "${userAnswer}". Is the student's answer correct? Provide a very brief, one-sentence explanation and a score of CORRECT, PARTIAL, or INCORRECT.`;
            const result = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: { parts: [{ text: prompt }] },
              config: { responseMimeType: "application/json", responseSchema: { type: Type.OBJECT, properties: { evaluation: { type: Type.STRING }, score: { type: Type.STRING } } } }
            });
            const { evaluation, score } = JSON.parse(result.text);
            let scoreClass = 'incorrect';
            if (score.toUpperCase() === 'CORRECT') { scoreClass = 'correct'; quizScore += 2; } 
            else if (score.toUpperCase() === 'PARTIAL') { scoreClass = 'partial'; quizScore += 1; }

            feedbackContainer.innerHTML = `<div class="quiz-feedback ${scoreClass}"><strong class="${scoreClass}">${score.toUpperCase()} (+${score.toUpperCase() === 'CORRECT' ? 2 : (score.toUpperCase() === 'PARTIAL' ? 1 : 0)} pts)</strong><p><strong>Ë©ïÂÉπ:</strong> ${evaluation}</p><p><strong>Ê≠£Á¢∫Á≠îÊ°à:</strong> ${card.definition}</p></div>`;
            toggleLoading(submitBtn, false);
            submitBtn.textContent = getTranslation('nextQuestionButton');
            submitBtn.onclick = () => { quizIndex++; renderQuizMode(); };
        } catch (error) {
            console.error('Error evaluating answer:', error);
            feedbackContainer.innerHTML = `<p class="error">Ë©ï‰º∞Á≠îÊ°àÊôÇÂá∫ÈåØÔºåË´ãÈáçË©¶„ÄÇ</p>`;
            toggleLoading(submitBtn, false);
            submitBtn.textContent = getTranslation('submitAnswerButton');
        }
    }

    function renderQuizEndScreen() {
        contentArea.innerHTML = `
            <div class="quiz-container">
                <h2>${getTranslation('quizCompleteTitle')}</h2>
                <p class="progress-text">${getTranslation('finalScore')}: ${quizScore} / ${maxQuizScore}</p>
                <button id="restartQuizBtn">${getTranslation('restartQuizButton')}</button>
            </div>`;
        document.getElementById('restartQuizBtn').addEventListener('click', () => {
            quizIndex = 0; quizScore = 0; renderQuizMode();
        });
    }
    
    function renderMatchGame() {
        let gameItems = [];
        flashcards.forEach((card, index) => {
            gameItems.push({ text: card.term, pairId: index, type: 'term' });
            gameItems.push({ text: card.definition, pairId: index, type: 'definition' });
        });
        
        gameItems.sort(() => Math.random() - 0.5); // Shuffle

        const gameContainer = document.createElement('div');
        gameContainer.className = 'match-game-container';
        
        gameItems.forEach(item => {
            const cardEl = document.createElement('div');
            cardEl.className = 'match-card';
            cardEl.dataset.pairId = item.pairId;
            cardEl.innerHTML = `<div class="match-card-content">${item.text}</div>`;
            gameContainer.appendChild(cardEl);
        });
        contentArea.appendChild(gameContainer);

        let flippedCards = [];
        let matchedPairs = 0;
        
        gameContainer.addEventListener('click', (e) => {
            const clickedCard = e.target.closest('.match-card');
            if (!clickedCard || clickedCard.classList.contains('flipped') || flippedCards.length >= 2) {
                return;
            }

            clickedCard.classList.add('flipped');
            flippedCards.push(clickedCard);

            if (flippedCards.length === 2) {
                const [card1, card2] = flippedCards;
                if (card1.dataset.pairId === card2.dataset.pairId) {
                    // Match
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    flippedCards = [];
                    matchedPairs++;
                    if (matchedPairs === flashcards.length) {
                        setTimeout(renderMatchEndScreen, 600);
                    }
                } else {
                    // Mismatch
                    card1.classList.add('mismatched');
                    card2.classList.add('mismatched');
                    setTimeout(() => {
                        card1.classList.remove('flipped', 'mismatched');
                        card2.classList.remove('flipped', 'mismatched');
                        flippedCards = [];
                    }, 1000);
                }
            }
        });
    }

    function renderMatchEndScreen() {
        contentArea.innerHTML = `
            <div class="quiz-container match-completion-message">
                <h2>${getTranslation('matchGameComplete')}</h2>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button id="playAgainBtn">${getTranslation('playAgainButton')}</button>
                    <button id="returnToStudyBtn" class="button secondary">${getTranslation('returnToStudyButton')}</button>
                </div>
            </div>`;
        document.getElementById('playAgainBtn').addEventListener('click', renderMatchGame);
        document.getElementById('returnToStudyBtn').addEventListener('click', () => handleStudyModeChange('study'));
    }

    // --- Dictation Mode AI Functions ---
    async function translateVocabulary() {
        if (!initializeAi()) return;
        const list = dictationListInput.value.trim();
        if (!list) { handleError('errorDictationList'); return; }

        showStatus('statusTranslating');
        toggleLoading(translateButton, true);
        
        try {
            const prompt = `For the following list of English vocabulary, provide a concise Traditional Chinese translation for each item suitable for HKDSE students. Here is the list:\n\n${list}`;
            const result = await ai.models.generateContent({
                model: 'gemini-2.5-flash', contents: { parts: [{ text: prompt }] }, config: { responseMimeType: "application/json", responseSchema: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { english: { type: Type.STRING }, chinese: { type: Type.STRING } } } } }
            });
            const translations = JSON.parse(result.text);
            if (translations && translations.length > 0) {
                dictationListInput.value = translations.map(t => `${t.english} - ${t.chinese}`).join('\n');
                showStatus('');
            }
        } catch(error) {
            console.error('Error translating list:', error);
            handleError('errorGeneral', error.message || getTranslation('errorUnknown'));
        } finally {
            toggleLoading(translateButton, false);
        }
    }

    async function parseVocabularyList() {
        if (!initializeAi()) return null;
        const list = dictationListInput.value.trim();
        if (!list) { handleError('errorDictationList'); return null; }

        showStatus('statusParsing');
        toggleLoading(startDictationButton, true);
        
        try {
            const prompt = `Analyze the following text which contains a vocabulary list. For each item, identify the primary English term and its corresponding Traditional Chinese translation, if one is provided. Structure the output as a JSON array of objects, where each object has an "english" key and a "chinese" key. If no Chinese translation is found for an item, the value for "chinese" should be an empty string. Text:\n\n${list}`;
            const result = await ai.models.generateContent({
                model: 'gemini-2.5-flash', contents: { parts: [{ text: prompt }] }, config: { responseMimeType: "application/json", responseSchema: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { english: { type: Type.STRING }, chinese: { type: Type.STRING } } } } }
            });
            const parsedList = JSON.parse(result.text);
            if (parsedList && parsedList.length > 0) {
                return parsedList.filter(item => item.english); // Filter out any empty entries
            }
            return null;
        } catch(error) {
            console.error('Error parsing list:', error);
            handleError('errorGeneral', error.message || getTranslation('errorUnknown'));
            return null;
        } finally {
            toggleLoading(startDictationButton, false);
            showStatus('');
        }
    }

    // --- Dictation Mode Functions ---
    async function startDictation() {
        if (!('speechSynthesis' in window)) { handleError('errorSpeechSynthesis'); return; }
        const parsedWords = await parseVocabularyList();
        if (!parsedWords || parsedWords.length === 0) { handleError('errorNoValidWords'); return; }
        
        dictationWords = parsedWords;
        userAnswers = [];
        currentDictationIndex = 0;
        showStatus('');
        showDictationPage(true);
        renderDictationPractice();
    }
    
    function renderDictationPractice() {
        dictationPage.innerHTML = '';
        if (currentDictationIndex >= dictationWords.length) {
            renderDictationResults();
            return;
        }

        const currentItem = dictationWords[currentDictationIndex];
        const content = document.createElement('div');
        content.className = 'dictation-page-content';
        content.innerHTML = `
            <button class="back-button dictation-page-back-button" aria-label="${getTranslation('backButtonLabel')}">‚Üê</button>
            <div class="progress-text">${getTranslation('dictationWord')} ${currentDictationIndex + 1} / ${dictationWords.length}</div>
            ${currentItem.chinese ? `<div class="dictation-translation">${currentItem.chinese}</div>` : ''}
            <button class="dictation-listen-button" aria-label="Listen to the word">üîä</button>
            <input type="text" class="dictation-answer-input" placeholder="${getTranslation('quizAnswerPlaceholder')}" />
            <div id="dictationFeedback" class="dictation-feedback"></div>
            <button id="checkDictationBtn">${getTranslation('checkButton')}</button>`;
        dictationPage.appendChild(content);

        const listenBtn = content.querySelector('.dictation-listen-button');
        const checkBtn = content.querySelector('#checkDictationBtn');
        const answerInput = content.querySelector('.dictation-answer-input');
        const backBtn = content.querySelector('.dictation-page-back-button');
        
        answerInput.focus();
        speakWord(currentItem.english);

        listenBtn.addEventListener('click', () => speakWord(currentItem.english));
        const checkAnswerHandler = () => checkDictationAnswer(answerInput, currentItem, checkBtn);
        checkBtn.addEventListener('click', checkAnswerHandler);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') checkAnswerHandler();
        });
        backBtn.addEventListener('click', () => {
          showDictationPage(false);
          showView('dictation');
        });
    }
    
    function speakWord(word) {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US'; // Ensure correct pronunciation
        speechSynthesis.speak(utterance);
    }

    function checkDictationAnswer(inputEl, currentItem, buttonEl) {
        const userAnswer = inputEl.value.trim();
        if (!userAnswer) return;

        const correctWord = currentItem.english;
        const isCorrect = userAnswer.toLowerCase() === correctWord.toLowerCase();
        userAnswers.push({ word: correctWord, userAnswer, isCorrect });
        
        inputEl.disabled = true;
        inputEl.style.borderColor = isCorrect ? 'var(--correct-color)' : 'var(--error-color)';
        
        const feedbackEl = document.getElementById('dictationFeedback');
        if (!isCorrect) {
            feedbackEl.textContent = `${getTranslation('feedbackCorrectAnswerIs')} ${correctWord}`;
            feedbackEl.style.color = 'var(--error-color)';
        } else {
            feedbackEl.textContent = '‚úî';
            feedbackEl.style.color = 'var(--correct-color)';
        }

        buttonEl.textContent = getTranslation('nextWordButton');
        buttonEl.focus();
        buttonEl.onclick = () => {
            currentDictationIndex++;
            renderDictationPractice();
        };
    }
    
    function renderDictationResults() {
        const correctCount = userAnswers.filter(a => a.isCorrect).length;
        const content = document.createElement('div');
        content.className = 'dictation-page-content';

        let tableRows = userAnswers.map(answer => `
            <tr>
                <td data-label="${getTranslation('correctWord')}">${answer.word}</td>
                <td data-label="${getTranslation('yourAnswer')}">
                    <span class="${answer.isCorrect ? '' : 'status-incorrect'}">${answer.userAnswer || '-'}</span>
                    ${!answer.isCorrect ? `<div class="correct-answer-feedback">${getTranslation('feedbackCorrectAnswerIs')} ${answer.word}</div>` : ''}
                </td>
                <td data-label="${getTranslation('status')}" class="${answer.isCorrect ? 'status-correct' : 'status-incorrect'}">${answer.isCorrect ? '‚úî' : '‚úñ'}</td>
            </tr>`).join('');

        content.innerHTML = `
            <h2>${getTranslation('dictationCompleteTitle')}</h2>
            <p class="progress-text">${getTranslation('finalScore')}: ${correctCount} / ${dictationWords.length}</p>
            <div style="max-height: 40vh; overflow-y: auto;">
              <table class="dictation-results-table">
                  <thead><tr><th>${getTranslation('correctWord')}</th><th>${getTranslation('yourAnswer')}</th><th>${getTranslation('status')}</th></tr></thead>
                  <tbody>${tableRows}</tbody>
              </table>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center;">
                <button id="practiceAgainBtn">${getTranslation('practiceAgainButton')}</button>
                <button id="backToMenuBtn" class="button secondary">${getTranslation('backToMenuButton')}</button>
            </div>`;
        dictationPage.innerHTML = '';
        dictationPage.appendChild(content);
        
        document.getElementById('practiceAgainBtn').addEventListener('click', startDictation);
        document.getElementById('backToMenuBtn').addEventListener('click', () => {
            showDictationPage(false);
            showView('selection');
        });
    }
    
    // --- Start the App ---
    initialize();

  </script>
</body>
</html>
